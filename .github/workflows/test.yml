name: Unit Testing

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  test_application:
    name: Run unit tests
    runs-on: [self-hosted, aphq-sarkari]
    steps:
    - uses: actions/checkout@v3
      name: Checkout repository
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v2
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
    - run: poetry install
      name: Install dependencies
    - run: |
        site_packages=$(find $(poetry env info -p) -name site-packages -type d)
        echo "Site packages: $site_packages"
        find $site_packages/astro_plasma/data -type l -exec rm "{}" \;
        ln -s /media/AstroPlasma/ionization  "$site_packages/astro_plasma/data/"
        ln -s /media/AstroPlasma/emission  "$site_packages/astro_plasma/data/"
      name: Mount datasets in local cache
    - run: poetry run ./manage.py test
      name: Run unit test
      env:
        PY_ENV: testing
